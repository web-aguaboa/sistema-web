<!DOCTYPE html>
<html>
<head>
    <title>üö® Debug Final - Edi√ß√£o de A√ß√£o</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 12px 20px; margin: 8px 4px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; border: 1px solid #e9ecef; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 80px; }
        .status { font-weight: bold; margin: 10px 0; }
        .log { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; height: 200px; overflow-y: auto; }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Debug Final - Edi√ß√£o de A√ß√£o</h1>
        <p>Este √© um teste completo e detalhado da funcionalidade de edi√ß√£o de a√ß√µes.</p>
        
        <div class="step">
            <h3>1Ô∏è‚É£ Status do Sistema</h3>
            <button onclick="verificarSistema()">Verificar Sistema</button>
            <div id="statusSistema"></div>
        </div>
        
        <div class="step">
            <h3>2Ô∏è‚É£ Carregar A√ß√£o para Edi√ß√£o</h3>
            <button onclick="carregarAcao()">Carregar A√ß√£o ID 1</button>
            <div id="statusCarregar"></div>
        </div>
        
        <div class="step">
            <h3>3Ô∏è‚É£ Formul√°rio de Edi√ß√£o</h3>
            <div class="form-group">
                <label>ID da A√ß√£o:</label>
                <input type="number" id="actionId" value="1" readonly>
            </div>
            <div class="form-group">
                <label>Data da A√ß√£o:</label>
                <input type="date" id="dataAcao">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o:</label>
                <textarea id="descricao" placeholder="Digite a nova descri√ß√£o..."></textarea>
            </div>
            <div class="form-group">
                <label>Arquivo (opcional):</label>
                <input type="file" id="arquivo" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx">
            </div>
            <button class="success" onclick="executarEdicao()">Executar Edi√ß√£o</button>
            <div id="statusEdicao"></div>
        </div>
        
        <div class="step">
            <h3>4Ô∏è‚É£ Teste Direto da API</h3>
            <button onclick="testeAPIDirecto()">Teste API Direto</button>
            <div id="statusAPI"></div>
        </div>
        
        <div class="step">
            <h3>5Ô∏è‚É£ Log de Debug</h3>
            <button onclick="limparLog()">Limpar Log</button>
            <div id="logDebug" class="log"></div>
        </div>
    </div>

    <script>
        let acaoCarregada = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logDebug');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function limparLog() {
            document.getElementById('logDebug').innerHTML = '';
        }
        
        async function verificarSistema() {
            log('üîç Verificando status do sistema...');
            
            const statusDiv = document.getElementById('statusSistema');
            let html = '<div class="status">Status do Sistema:</div>';
            
            // Verificar se estamos na URL correta
            html += `<p><strong>URL Atual:</strong> ${window.location.href}</p>`;
            
            // Verificar se conseguimos acessar a API b√°sica
            try {
                const response = await fetch('/action/1');
                if (response.ok) {
                    html += '<p class="status-ok">‚úÖ API acess√≠vel</p>';
                    log('API acess√≠vel', 'success');
                } else {
                    html += `<p class="status-error">‚ùå API com problema (Status: ${response.status})</p>`;
                    log(`API com problema: ${response.status}`, 'error');
                }
            } catch (error) {
                html += '<p class="status-error">‚ùå Erro na comunica√ß√£o com API</p>';
                log(`Erro API: ${error.message}`, 'error');
            }
            
            statusDiv.innerHTML = html;
        }
        
        async function carregarAcao() {
            log('üì• Carregando a√ß√£o ID 1...');
            
            const statusDiv = document.getElementById('statusCarregar');
            
            try {
                const response = await fetch('/action/1');
                log(`Resposta: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`);
                
                const data = await response.json();
                log(`Dados recebidos: ${JSON.stringify(data)}`, 'success');
                
                acaoCarregada = data;
                
                // Preencher formul√°rio
                document.getElementById('dataAcao').value = data.data_acao || '';
                document.getElementById('descricao').value = data.descricao || '';
                
                statusDiv.innerHTML = `
                    <div class="success">
                        <div class="status">‚úÖ A√ß√£o carregada com sucesso!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                log(`Erro ao carregar a√ß√£o: ${error.message}`, 'error');
                statusDiv.innerHTML = `
                    <div class="error">
                        <div class="status">‚ùå Erro ao carregar a√ß√£o</div>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
        
        async function executarEdicao() {
            log('üìù Executando edi√ß√£o de a√ß√£o...');
            
            if (!acaoCarregada) {
                alert('‚ùå Carregue a a√ß√£o primeiro!');
                return;
            }
            
            const statusDiv = document.getElementById('statusEdicao');
            const actionId = document.getElementById('actionId').value;
            const dataAcao = document.getElementById('dataAcao').value;
            const descricao = document.getElementById('descricao').value;
            const arquivo = document.getElementById('arquivo').files[0];
            
            log(`Preparando edi√ß√£o - ID: ${actionId}, Data: ${dataAcao}, Descri√ß√£o: ${descricao.substring(0, 50)}...`);
            
            if (arquivo) {
                log(`Arquivo selecionado: ${arquivo.name} (${arquivo.size} bytes)`);
            }
            
            try {
                const formData = new FormData();
                formData.append('descricao', descricao);
                formData.append('data_acao', dataAcao);
                
                if (arquivo) {
                    formData.append('arquivo', arquivo);
                }
                
                log('FormData preparado, enviando requisi√ß√£o...');
                
                const response = await fetch(`/action/${actionId}`, {
                    method: 'POST',
                    body: formData
                });
                
                log(`Resposta recebida: ${response.status} ${response.statusText}`);
                
                const responseText = await response.text();
                log(`Resposta raw: ${responseText}`);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    log(`JSON parseado: ${JSON.stringify(data)}`);
                } catch (parseError) {
                    log(`Erro ao parsear JSON: ${parseError.message}`, 'error');
                    throw new Error(`Resposta n√£o √© JSON v√°lido: ${responseText}`);
                }
                
                if (data.success) {
                    log('‚úÖ Edi√ß√£o realizada com sucesso!', 'success');
                    statusDiv.innerHTML = `
                        <div class="success">
                            <div class="status">‚úÖ A√ß√£o editada com sucesso!</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    log(`‚ùå Erro na edi√ß√£o: ${data.message}`, 'error');
                    statusDiv.innerHTML = `
                        <div class="error">
                            <div class="status">‚ùå Erro na edi√ß√£o</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                statusDiv.innerHTML = `
                    <div class="error">
                        <div class="status">‚ùå Erro na requisi√ß√£o</div>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
        
        async function testeAPIDirecto() {
            log('üß™ Testando API direto...');
            
            const statusDiv = document.getElementById('statusAPI');
            
            try {
                // Teste simples de ping
                const testData = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                };
                
                log(`Dados de teste: ${JSON.stringify(testData)}`);
                
                const formData = new FormData();
                formData.append('descricao', 'Teste API direto - ' + new Date().toLocaleTimeString());
                formData.append('data_acao', new Date().toISOString().split('T')[0]);
                
                const response = await fetch('/action/1', {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                
                statusDiv.innerHTML = `
                    <div class="${response.ok ? 'success' : 'error'}">
                        <div class="status">Status: ${response.status} ${response.statusText}</div>
                        <p><strong>Headers:</strong></p>
                        <pre>${Array.from(response.headers.entries()).map(([k,v]) => `${k}: ${v}`).join('\\n')}</pre>
                        <p><strong>Response:</strong></p>
                        <pre>${responseText}</pre>
                    </div>
                `;
                
                log(`Teste API conclu√≠do - Status: ${response.status}`, response.ok ? 'success' : 'error');
                
            } catch (error) {
                log(`Erro no teste API: ${error.message}`, 'error');
                statusDiv.innerHTML = `
                    <div class="error">
                        <div class="status">‚ùå Erro no teste</div>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
        
        // Log inicial
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de debug carregado', 'success');
            log('Pronto para testar a funcionalidade de edi√ß√£o');
        });
    </script>
</body>
</html>