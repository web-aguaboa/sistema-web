<!DOCTYPE html>
<html>
<head>
    <title>üß™ Teste Final - Edi√ß√£o com Prazo</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 12px 20px; margin: 8px 4px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 80px; }
        .checkbox-group { display: flex; align-items: center; margin: 15px 0; padding: 10px; background: #e3f2fd; border-radius: 4px; }
        .checkbox-group input[type="checkbox"] { width: auto; margin-right: 10px; }
        .prazo-field { background: #f0f8ff; padding: 15px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #007bff; }
        .log { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 4px; font-family: monospace; height: 300px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Final: Edi√ß√£o com Prazo</h1>
        <p>Este teste replica exatamente o cen√°rio do erro reportado.</p>
        
        <div class="step">
            <h3>üìã Formul√°rio de Edi√ß√£o</h3>
            <form id="formEdicao">
                <div class="form-group">
                    <label>ID da A√ß√£o:</label>
                    <input type="number" id="actionId" value="1" readonly>
                </div>
                
                <div class="form-group">
                    <label>Data:</label>
                    <input type="date" id="dataAcao" value="2025-10-01" required>
                </div>
                
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <textarea id="descricao" required>5% de desconto</textarea>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="temPrazo" checked>
                    <label for="temPrazo">üìÖ Esta a√ß√£o tem prazo de conclus√£o</label>
                </div>
                
                <div class="prazo-field">
                    <label>Prazo de Conclus√£o:</label>
                    <input type="month" id="prazoInput" value="2025-12">
                    <small>Valor usado no teste: dezembro de 2025</small>
                </div>
                
                <button type="submit" class="success">Salvar Altera√ß√µes</button>
                <button type="button" onclick="carregarDadosOriginais()" class="warning">Carregar Dados Originais</button>
            </form>
        </div>
        
        <div class="step">
            <h3>üìä Resultado da Opera√ß√£o</h3>
            <div id="resultado"></div>
        </div>
        
        <div class="step">
            <h3>üìù Log de Debug</h3>
            <button onclick="limparLog()">Limpar Log</button>
            <div id="logDebug" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logDebug');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function limparLog() {
            document.getElementById('logDebug').innerHTML = '';
        }
        
        async function carregarDadosOriginais() {
            log('üì• Carregando dados originais da a√ß√£o...');
            
            try {
                const response = await fetch('/action/1');
                const data = await response.json();
                
                log(`‚úÖ Dados carregados: ${JSON.stringify(data)}`);
                
                // Preencher formul√°rio
                document.getElementById('dataAcao').value = data.data_acao || '';
                document.getElementById('descricao').value = data.descricao || '';
                
                // Configurar prazo
                if (data.prazo_conclusao) {
                    document.getElementById('temPrazo').checked = true;
                    const prazoDate = new Date(data.prazo_conclusao + 'T00:00:00');
                    const anoMes = prazoDate.getFullYear() + '-' + String(prazoDate.getMonth() + 1).padStart(2, '0');
                    document.getElementById('prazoInput').value = anoMes;
                    log(`‚úÖ Prazo configurado: ${anoMes}`);
                } else {
                    document.getElementById('temPrazo').checked = false;
                    log('‚ÑπÔ∏è Sem prazo definido');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
            }
        }
        
        document.getElementById('formEdicao').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            log('üöÄ Iniciando processo de edi√ß√£o...');
            
            const actionId = document.getElementById('actionId').value;
            const dataAcao = document.getElementById('dataAcao').value;
            const descricao = document.getElementById('descricao').value;
            const temPrazo = document.getElementById('temPrazo').checked;
            const prazoInput = document.getElementById('prazoInput').value;
            
            log(`üìã Dados do formul√°rio:`);
            log(`  ID: ${actionId}`);
            log(`  Data: ${dataAcao}`);
            log(`  Descri√ß√£o: "${descricao}"`);
            log(`  Tem prazo: ${temPrazo}`);
            log(`  Prazo: ${prazoInput}`);
            
            // Valida√ß√µes b√°sicas
            if (!descricao.trim()) {
                log('‚ùå Descri√ß√£o n√£o pode estar vazia', 'error');
                alert('‚ùå Descri√ß√£o √© obrigat√≥ria');
                return;
            }
            
            if (!dataAcao) {
                log('‚ùå Data n√£o pode estar vazia', 'error');
                alert('‚ùå Data √© obrigat√≥ria');
                return;
            }
            
            try {
                // Criar FormData
                const formData = new FormData();
                formData.append('descricao', descricao);
                formData.append('data_acao', dataAcao);
                
                if (temPrazo && prazoInput) {
                    formData.append('prazo_conclusao', prazoInput);
                    log(`‚úÖ Prazo adicionado ao FormData: ${prazoInput}`);
                } else {
                    log('‚ÑπÔ∏è Nenhum prazo ser√° enviado');
                }
                
                // Log do FormData
                log('üì§ Conte√∫do do FormData:');
                for (let [key, value] of formData.entries()) {
                    log(`  ${key}: "${value}"`);
                }
                
                log('üåê Enviando requisi√ß√£o POST...');
                
                const response = await fetch(`/action/${actionId}`, {
                    method: 'POST',
                    body: formData
                });
                
                log(`üì• Resposta recebida:`);
                log(`  Status: ${response.status} ${response.statusText}`);
                log(`  Content-Type: ${response.headers.get('content-type')}`);
                
                // Ler resposta
                const responseText = await response.text();
                log(`üìÑ Resposta bruta: "${responseText}"`);
                
                // Tentar parsear JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    log(`‚úÖ JSON parseado com sucesso`);
                } catch (parseError) {
                    log(`‚ùå Erro ao parsear JSON: ${parseError.message}`, 'error');
                    throw new Error(`Resposta inv√°lida: ${responseText}`);
                }
                
                // Mostrar resultado
                const resultDiv = document.getElementById('resultado');
                
                if (data.success) {
                    log('üéâ Edi√ß√£o realizada com sucesso!', 'success');
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Sucesso!</h4>
                            <p>${data.message}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    log(`‚ùå Erro na edi√ß√£o: ${data.message}`, 'error');
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erro!</h4>
                            <p>${data.message}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`üí• Erro fatal: ${error.message}`, 'error');
                
                document.getElementById('resultado').innerHTML = `
                    <div class="error">
                        <h4>üí• Erro Fatal</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema carregado');
            log('Pronto para testar a edi√ß√£o com prazo');
            
            // Carregar dados originais automaticamente
            carregarDadosOriginais();
        });
    </script>
</body>
</html>